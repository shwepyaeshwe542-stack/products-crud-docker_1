version: '3.8' # Specify a modern version

services:
  database:
    image: postgres:15-alpine
    container_name: products_db
    environment:
      # Use environment variables for credentials
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    
    # Expose to the host only if needed (e.g., for external tools)
    ports:
      - "${DB_PORT:-5432}:5432" 
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - app-network

  backend:
    build: ./backend
    container_name: products_backend
    ports:
      - "${BACKEND_PORT:-4000}:4000"
    
    environment:
      # FIX: Changed :${DB_PORT} to :5432 (the internal container port)
      DATABASE_URL: postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${POSTGRES_DB}?schema=public
      
      # It's better to use environment vars defined in .env
      # NODE_ENV should be defined in your .env file
      NODE_ENV: production
      
      # Add the host port for the frontend to know where the backend is
      BACKEND_PORT: ${BACKEND_PORT}
    
    depends_on:
      database:
        condition: service_healthy # Wait for the database to be fully ready
    
    # It's good practice to mount your node_modules as a volume 
    # if you want to speed up container build/rebuild, but for basic setup, 
    # volumes:
    #   - ./backend/uploads:/app/uploads
    # is sufficient if node_modules is inside the build context.
    
    volumes:
      - ./backend/uploads:/app/uploads
    restart: unless-stopped
    networks:
      - app-network

  frontend:
    build: ./frontend
    container_name: products_frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    
    environment:
      # NOTE: For containers to talk to the HOST's localhost, they need a special host.
      # However, for the frontend in the browser to talk to the backend on the host, 
      # "http://localhost:4000" is correct if you access the frontend at http://localhost:3000.
      NEXT_PUBLIC_API_URL: http://localhost:4000
    
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

# Define networks and volumes
networks:
  app-network:
    driver: bridge

volumes:
  postgres_data: